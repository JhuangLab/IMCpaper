{
  "hash": "47a69fdf133aad8402c5200782403607",
  "result": {
    "engine": "knitr",
    "markdown": "# figure1\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npkgs <- c(\"SingleCellExperiment\", \"ggthemes\", \"ggpubr\", \"vroom\", \"jhtools\", \n          \"patchwork\", \"cowplot\", \"tidyverse\", \"dplyr\", \"ComplexHeatmap\", \n          \"viridis\", \"factoextra\", \"pheatmap\", \"RColorBrewer\", \"circlize\", \n          \"jhuanglabHyperion\")\nsuppressMessages(conflicted::conflict_scout())\nfor (pkg in pkgs){\n  suppressPackageStartupMessages(library(pkg, character.only = T))\n}\nres_dir <- \"./results/figure1\" %>% checkdir\ndat_dir <- \"./data\" %>% checkdir\nconfig_dir <- \"./config\" %>% checkdir\n\n#colors config\nconfig_fn <- glue::glue(\"{config_dir}/configs.yaml\")\nstype3_cols <- jhtools::show_me_the_colors(config_fn, \"stype3\")\nctype10_cols <- jhtools::show_me_the_colors(config_fn, \"cell_type_new\")\n\n#read in data\ncoldat <- readr::read_csv(glue::glue(\"{dat_dir}/sce_coldata.csv\"))\nsinfo <- readr::read_csv(glue::glue(\"{dat_dir}/metadata_sinfo.csv\"))\nmetadata <- readr::read_rds(glue::glue(\"{dat_dir}/metadata.rds\"))\nseu_sub <- readr::read_rds(glue::glue(\"{dat_dir}/sce_sub_fig1f.rds\"))\n\n#theme\nplot.theme <- theme_bw() + theme(panel.grid.major = element_blank(), \n                                 panel.grid.minor = element_blank())\n\naxistheme1 <- theme(axis.title.y = element_text(size = 7),\n                    axis.text.y = element_text(size = 7),\n                    axis.title.x = element_blank(),\n                    axis.ticks.x =  element_blank(),\n                    axis.text.x = element_blank())\n\naxistheme2 <- theme(axis.title.y = element_text(size = 8),\n                    axis.text.y = element_text(size = 6),\n                    axis.title.x = element_blank(),\n                    axis.text.x = element_blank(),\n                    axis.line = element_line(linewidth = .4, colour = \"black\"),\n                    axis.ticks.y = element_line(linewidth = .4, colour = \"black\"),\n                    axis.ticks.x = element_blank(),\n                    legend.position = \"none\")\n```\n:::\n\n\n\n\n\n\n## figure1a\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsp_info <- coldat %>% dplyr::select(sample_id, stype3) %>% distinct() %>% \n    remove_rownames() %>% dplyr::mutate(group = ifelse(stype3 != \"Paracancerous\" & \n                                                  stype3 != \"Normal\", \"Tumor\", stype3))\n\nsp_info$group <- factor(sp_info$group, levels = c(\"Tumor\", \"Paracancerous\", \"Normal\"))\nsp_info$stype3 <- factor(sp_info$stype3, levels = c(\"Punc_liver\", \"Punc_pancreas\",\n                                                    \"Surgery_after_chemo\", \"Surgery_without_chemo\",\n                                                    \"Paracancerous\", \"Normal\"))\n\n# plot\np <- ggplot(sp_info, aes(x = group, fill = stype3)) +\n  geom_bar(position = \"stack\", width = 0.8) +\n  scale_fill_manual(values = stype3_cols) +\n  scale_y_continuous(breaks = scales::pretty_breaks(n = 5)) +\n  theme_classic() +\n  theme(axis.text.x = element_text(angle = 60, hjust = 1),\n        axis.title.x = element_blank(),\n        axis.title.y = element_blank(),\n        legend.title = element_blank()) +\n  geom_text(aes(label = ..count..), stat = \"count\", position = position_stack(vjust = 0.5))\nggsave(glue::glue(\"{res_dir}/fig1a_sample_info.pdf\"), width = 3, height = 6)\np\n```\n\n::: {.cell-output-display}\n![](figure1_files/figure-html/figure1a-1.png){width=288}\n:::\n:::\n\n\n\n\n\n\n## figure1d\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nmeta_all <- readr::read_csv(glue::glue(\"{dat_dir}/metadata_sinfo.csv\"))\nc_mat_lst <- readr::read_rds(glue::glue(\"{dat_dir}/heatmap_1d_mat_lst.rds\"))\nc_mat <- c_mat_lst[[1]]\ncluster_prop <- c_mat_lst[[2]]\n\n# lineage markers\nanno_marks <- c(\"a_smooth\", \"CD14\", \"CD33\", \"CD16\", \"CD163\", \"Pan_Keratin\", \"CD11b\",\n                \"CD31\", \"CD11c\", \"FoxP3\", \"CD4\", \"E_Cadherin\", \"CD68\",\n                \"CD20\", \"CD8a\", \"Collagen1\", \"CD3\", \"HLA_DR\",\"CD25\",\n                \"Vimentin\", \"CCR6\", \"B7_H4\", \"Ki67\")\n\n# cell grouping and ordering data for heatmap\n# the ordering should NOT be changed to avoid bugs of ComplexHeatmap package!!\nepiendo_cells <- c(\"Epithelial tumor cell\", \"Normal epithelial cell\", \"Endothelial cell\")\nimmu_stroma_cells <- c(\"DC\", \"MDSC\", \"Monocyte\", \"B cell\", \"CD8+ T cell\", \"CD4+ T cell\",\n                 \"HLA-DR-CD163- mp\", \"HLA-DR-CD163+ mp\", \"HLA-DR+CD163- mp\",\n                   \"HLA-DR+CD163+ mp\", \"HLA-DR-CD163- MMT\", \"HLA-DR+CD163- MMT\", \n                 \"HLA-DR+CD163+ MMT\", \"PSC\", \"myoCAF\", \"Col1+ CAF\")\nother_cells <- c(\"CCR6+ cell\", \"B7-H4+ cell\", \"Ki67+ cell\", \"Vim+ cell\", \"Unknown\")\n\ngrouping_celltype <- data.frame(cell_type_new = c(epiendo_cells, immu_stroma_cells, other_cells),\n                                meta_celltype = c(rep(\"Epi-endo\", 3), rep(\"Immune-stroma\", 16), rep(\"Others\", 5)))\n\nheatmap_dat <- c_mat[grouping_celltype$cell_type_new, anno_marks]\nsplit_row <- grouping_celltype$meta_celltype\nsplit_row <- factor(split_row, levels = c(\"Epi-endo\", \"Immune-stroma\", \"Others\"))\n\nmeta_colors <- c(\"#B61932\", \"#568AC2\", \"#BEA278\")\nlabels_meta <- c(\"Epi-endo\", \"Immune-stroma\", \"Others\")\nlabels_meta2 <- c(\"Epithelial & endothelial Cells\", \"Immune & stroma Cells\", \"Other Cells\")\nblock_anno = rowAnnotation(Type = anno_block(gp = gpar(fill = meta_colors),\n                                             labels = labels_meta,\n                                             labels_gp = gpar(col = \"white\", fontsize = 10)))\n\ncol_fun = circlize::colorRamp2(c(-1, 0, 1, 2, 3), c(\"#5658A5\", \"#8BCDA3\", \"#FBF4AA\", \"#F16943\", \"#9D1A44\"))\nprop_data <- cluster_prop[ ,3]\nnames(prop_data) <- cluster_prop[ ,1]\n\n# bar annotation\nmeta_all1 <- meta_all %>% dplyr::mutate(base_excision_eval = case_when(\n  nchar(base_excision_eval) == 4 ~ \"BRPC_LAPC\",\n  TRUE ~ base_excision_eval))\ncoldat <- left_join(coldat, meta_all1[, c(\"sample_id\", \"base_excision_eval\")])\ngroup_dat <- coldat %>% group_by(cell_type_new) %>%\n  dplyr::mutate(allcount = n()) %>%\n  group_by(cell_type_new, base_excision_eval, allcount) %>%\n  summarise(count = n()) %>%\n  na.omit() %>% dplyr::mutate(frac = count / allcount)\ngroup_dat$cell_type_order <- factor(group_dat$cell_type_new,\n                                    levels = rev(grouping_celltype$cell_type_new))\nprop_data <- prop_data[match(rownames(heatmap_dat), names(prop_data))]\ncell_amount_anno = ComplexHeatmap::rowAnnotation(\n  frac = anno_barplot(prop_data,\n                      gp = gpar(fill = ctype10_cols[match(rownames(heatmap_dat), names(ctype10_cols))])))\ntext_color <- scales::muted(ctype10_cols[match(rev(grouping_celltype$cell_type_new), names(ctype10_cols))], l = 50)\n\n# bubble plot\ngroup_dat$base_order <- factor(group_dat$base_excision_eval,\n                               levels = c(\"RPC\", \"BRPC_LAPC\", \"MPC\"))\npcirc <- ggplot(group_dat, aes(y = cell_type_order, x = base_order)) +\n  geom_point(aes(color = cell_type_order, alpha = frac, size = count)) +\n  scale_color_manual(values = ctype10_cols) +\n  scale_size(range = c(1, 15), name = \"Fraction of clinical in celltype group\") +\n  theme(\n    axis.text.y = element_text(color = text_color),\n    # not officially supported but works anyway, one may also seek for ggtext solution\n    axis.text.x = element_text(angle = 90, vjust = 0.5, hjust = 1),\n    panel.grid.major = element_blank(),\n    panel.grid.minor = element_blank(),\n    panel.background = element_blank(),\n    axis.line = element_line(colour = \"black\"),\n    legend.position = \"none\",\n    axis.title.x = element_blank(),\n    axis.title.y = element_blank()\n  ) +\n  expand_limits(y = c(1, length(levels(group_dat$cell_type_order)) + 0.8))\n\n# main heatmap\nht_main <- Heatmap(heatmap_dat, name = \"matrix\", heatmap_legend_param = list(title = \"exp\"),\n                   cluster_row_slices = F, col = col_fun, row_km = 0,\n                   cluster_rows = F, show_heatmap_legend = F, left_annotation = block_anno,\n                   split = split_row, show_row_names = F, row_title = NULL,\n                   show_row_dend = F, show_column_dend = F)\n\nht <- attach_annotation(ht_main, cell_amount_anno, side = \"right\")\nht <- draw(ht)\n```\n\n::: {.cell-output-display}\n![](figure1_files/figure-html/figure1d-1.png){width=1248}\n:::\n\n```{.r .cell-code}\ngrob <- grid.grabExpr(draw(ht))\n\n# legends\nheat_legend <- Legend(title = \"Intensity\", at = -1:3, col_fun = col_fun)\nmeta_legend <- Legend(labels = labels_meta2, title = \"Cell Categories\",\n                      legend_gp = gpar(fill = meta_colors))\nmerged_legends <- packLegend(heat_legend, meta_legend)\n\n# merged plot\np <- ggdraw() +\n  draw_plot(pcirc, 0, 0.033, 0.27, 0.95) +   ## x, y, width, height\n  draw_plot(grob, 0.275, 0.001, 0.52, 0.98) +\n  draw_plot(grid.grabExpr(draw(merged_legends)), 0.84, 0.4, 0.06, 0.08)\nggsave(glue::glue(\"{res_dir}/fig1d_heatmap_main_anno.pdf\"), p, height = 7, width = 13)\np\n```\n\n::: {.cell-output-display}\n![](figure1_files/figure-html/figure1d-2.png){width=1248}\n:::\n:::\n\n\n\n\n\n\n## figure1d_sup2\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nfunc_marks <- c(\"CD45\", \"CD45RO\", \"EGFR\", \"PD_L1\", \"LAG_3\", \"Vista\", \"CCR6\", \"Arginase_1\", \"PD1\",\n                \"Vimentin\", \"B7_H4\", \"Granzyme_B\", \"Ki67\", \"Caspase3\")\n\nheatmap_dat <- c_mat[grouping_celltype$cell_type_new, func_marks]\ncolnames(heatmap_dat) <- c(\"CD45\", \"CD45RO\", \"EGFR\", \"PD-L1\", \"LAG3\", \"VISTA\", \"CCR6\", \"Arg-1\", \"PD-1\",\n                           \"Vim\", \"B7-H4\", \"GZMB\", \"Ki-67\", \"Casp-3\")\nht_func <- Heatmap(heatmap_dat, name = \"matrix\", heatmap_legend_param = list(title = \"exp\"),\n                   cluster_row_slices = F, col = col_fun, row_km = 0,\n                   cluster_rows = F, show_heatmap_legend = T, #left_annotation = block_anno,\n                   show_row_names = T,#split = split_row, row_title = NULL,\n                   show_row_dend = F, show_column_dend = F)\n\npdf(glue::glue(\"{res_dir}/fig1dsup2_heatmap_sup_functional.pdf\"), height = 6, width = 5)\ndraw(ht_func)\nd <- dev.off()\nht_func\n```\n\n::: {.cell-output-display}\n![](figure1_files/figure-html/figure1d_sup2-1.png){width=384}\n:::\n:::\n\n\n\n\n\n\n## figure1e\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ncelltypes <- unique(coldat$cell_type_new)\ncld <- coldat %>% group_by(stype3) %>% dplyr::mutate(n_cell = n()) %>%\n  group_by(cell_type_new, .add = T) %>% dplyr::mutate(cell_ratio = n()/n_cell)\ndf <- cld %>% ungroup() %>% dplyr::select(stype3, cell_type_new, cell_ratio) %>%\n  dplyr::distinct() %>% pivot_wider(names_from = cell_type_new, values_from = cell_ratio) %>%\n  dplyr::mutate(across(where(is.numeric), replace_na, 0)) %>%\n  pivot_longer(celltypes, names_to = \"cell_type\", values_to = \"ratio\")\ndf$stype3<- factor(df$stype3, levels = c(\"Surgery_without_chemo\", \"Surgery_after_chemo\", \"Punc_pancreas\", \"Punc_liver\", \"Paracancerous\", \"Normal\"))\nstack <- function (df = df) {\n  p <- ggplot(df, mapping = aes(stype3, ratio*100, fill = cell_type)) +\n    geom_bar(stat = 'identity', position = position_stack(), width = 0.8) +\n    labs(x = '', y = 'Cell percentage') +\n    theme_bw() + scale_fill_manual(values = ctype10_cols) +\n    theme(axis.title = element_text(size = 13),\n          axis.text.x = element_text(angle = 60, hjust = 1),\n          axis.title.x = element_blank(),\n          axis.ticks.x =  element_blank(),\n          axis.text.y = element_text(color = \"black\"),\n          axis.ticks = element_line(size = 0.25),\n          strip.text = element_text(size = 8),\n          strip.background = element_rect(fill = NA, color = NA),\n          legend.position = \"none\") +\n    scale_y_continuous(expand = c(0,0))\n  return(p)\n}\np <- stack(df = df)\nggsave(glue::glue(\"{res_dir}/fig1e_stype2_stackplot.pdf\"), p, width = 2, height = 3, dpi = 300)\np\n```\n\n::: {.cell-output-display}\n![](figure1_files/figure-html/figure1e-1.png){width=384}\n:::\n:::\n\n\n\n\n\n\n## figure1f\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\np <- plot2d(seu_sub, color.by = \"stype3\", show.cluser.id = F, size = 0.01,\n             item.use = c(\"t_sne1\", \"t_sne2\")) + scale_color_manual(values = stype3_cols) +\n  guides(colour = guide_legend(override.aes = list(size = 2)))\nggsave(glue::glue(\"{res_dir}/fig1f_tsne_stype3_300000.png\"), p, dpi = 300, width = 7, height = 5)       \n\nprint(p)\n```\n\n::: {.cell-output-display}\n![](figure1_files/figure-html/figure1f-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n## figure1sup4\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\ndf <- readr::read_csv(glue::glue(\"{dat_dir}/cell_score_stat.csv\"))\n\nmy_comparisons <- list(c(\"Normal\",\"Paracancerous\"), c(\"Normal\", \"Surgery_without_chemo\"),\n                       c(\"Paracancerous\", \"Surgery_without_chemo\"),\n                       c(\"Surgery_without_chemo\", \"Surgery_after_chemo\"),\n                       c(\"Punc_pancreas\", \"Punc_liver\"))\n\ndf$stype3 <- factor(df$stype3, levels = c(\"Surgery_without_chemo\", \"Surgery_after_chemo\", \"Punc_pancreas\",\"Punc_liver\", \"Paracancerous\", \"Normal\"))\n\np1 <- (ggplot(df, aes_string(x = \"stype3\", y = \"cell_density\")) +\n         geom_boxplot(outlier.shape= NA, lwd = 0.2, color = \"#000000\", fill = stype3_cols) +\n         ylim(0, 1.9) + \n         plot.theme +\n         theme(legend.position = \"none\") +\n         axistheme1+\n         stat_compare_means(method = \"wilcox.test\",\n                            comparisons = my_comparisons,\n                            hide.ns = TRUE,\n                            bracket.size = 0.2,\n                            vjust = 0.8,\n                            aes(label = ..p.signif..)))\np2 <- (ggplot(df, aes_string(x = \"stype3\", y = \"score_col\")) +\n         geom_boxplot(outlier.shape= NA, lwd = 0.2, color = \"#000000\", fill = stype3_cols) +\n         ylim(-2, 8) + \n         plot.theme +\n         theme(legend.position = \"none\") +\n         axistheme1+\n         stat_compare_means(method = \"wilcox.test\",\n                            comparisons = my_comparisons,\n                            hide.ns = TRUE,\n                            bracket.size = 0.2,\n                            vjust = 0.8,\n                            aes(label = ..p.signif..)))\np3 <- (ggplot(df, aes_string(x = \"stype3\", y = \"DispersionScore\")) +\n         geom_boxplot(outlier.shape= NA, lwd = 0.2, color = \"#000000\", fill = stype3_cols) +\n         ylim(0.3, 1.4) + \n         plot.theme +\n         theme(legend.position = \"none\") +\n         axistheme1+\n         stat_compare_means(method = \"wilcox.test\",\n                            comparisons = my_comparisons,\n                            hide.ns = TRUE,\n                            bracket.size = 0.2,\n                            vjust = 0.8,\n                            aes(label = ..p.signif..)))\n\np <- p2|p1|p3\nggsave(glue::glue(\"{res_dir}/fig1sup4_stype3_area_ecce_boxplot.pdf\"), p, width = 7, height = 5)       \nprint(p)\n```\n\n::: {.cell-output-display}\n![](figure1_files/figure-html/figure1sup4-1.png){width=672}\n:::\n:::\n\n\n\n\n\n\n## figure1sup5a\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# theme\nplot.theme <- theme_bw() + theme(panel.grid.major = element_blank(),\n                                 panel.grid.minor = element_blank())\n\naxistheme2 <- theme(axis.title.y = element_text(size = 8),\n                    axis.text.y = element_text(size = 6),\n                    axis.title.x = element_blank(),\n                    axis.text.x = element_blank(),\n                    axis.line = element_line(linewidth = .4, colour = \"black\"),\n                    axis.ticks.y = element_line(linewidth = .4, colour = \"black\"),\n                    axis.ticks.x = element_blank(),\n                    legend.position = \"none\")\n\n# plot function\nboxplot_clinical <- function (df = df, sel_group = \"stage\", celltype = \"DC\", axistheme = axistheme1, wd = .3,\n                              ylim = 400, label_y = c(0.4,0.5,0.6), compare = compare_list, fil_col = NULL) {\n  #colors <- list(color2, color3)\n  # dot_colors <- list(dot_color2, dot_color3)\n  plot.theme <- theme_bw() + theme(panel.grid.major = element_blank(),\n                                   panel.grid.minor = element_blank())\n\n  comparisons_n <- length(compare) + 2\n  p <- ggplot(df, aes_string(sel_group, celltype)) +\n    geom_boxplot(outlier.shape = NA, width = wd,\n                 lwd = 0.2, color = \"#000000\", aes(fill = !!sym(sel_group))) +\n    scale_y_continuous(limits=c(0, ylim), oob = scales::rescale_none) +\n    scale_fill_manual(values = fil_col) +\n    plot.theme + axistheme +\n    stat_compare_means(method = \"t.test\", comparisons = compare,\n                       hide.ns = TRUE, bracket.size = 0.2, vjust = 0.6,\n                       label.y = label_y, tip.length = 0.01,\n                       aes(label = ..p.signif..))\n  return(p)\n}\n\n# all immnue cells\nimmu_cols <- c(\"Macrophage_HLADRp\",\"MDSC\", \"Macrophage_HLADRp_CD163p\",\n               \"MMT_HLADRp_CD163p\", \"DC\", \"MMT_HLADRp\", \"Monocyte\",\n               \"MMT_HLADRn_CD163n\", \"CD8T\", \"Macrophage_CD163p\",\n               \"CD4T\", \"Macrophage_HLADRn_CD163n\", \"Bcell\")\n\n# tumor_para_normal\nsampleinfo <- sinfo %>% dplyr::select(sample_id, stype2) %>% distinct() %>% \n  dplyr::filter(stype2 %in% c(\"normal\", \"paracancerous\", \"tumor\"))\ntp_df <- metadata[[\"cell_ratio\"]] %>% inner_join(sampleinfo, by = \"sample_id\") %>%\n  dplyr::mutate(Epithelial = Epithelial_normal + Epithelial_tumor) %>%\n  dplyr::mutate(Fibroblast = PSC + mCAF + CAF_col1p) %>%\n  rowwise() %>% dplyr::mutate(immunecells = sum(c_across(all_of(immu_cols)))) %>%\n  dplyr::mutate(stype2 = case_when(stype2 == \"tumor\" ~ \"Tumor\",\n                                   stype2 == \"normal\" ~ \"Normal\",\n                                   stype2 == \"paracancerous\" ~ \"Paracancerous\"))\nmy_comparisons_tp <- list(c(\"Normal\",\"Paracancerous\"), c(\"Normal\", \"Tumor\"), c(\"Paracancerous\", \"Tumor\"))\ntp_df$stype2<- factor(tp_df$stype2, levels = c(\"Normal\", \"Paracancerous\", \"Tumor\"))\nfil_c <- c(\"Tumor\" = \"#BC3C29FF\", \"Paracancerous\" = \"#0072B5FF\", \"Normal\" = \"#E18727FF\")\n\np1 <- boxplot_clinical(df = tp_df, sel_group = \"stype2\", celltype = \"Epithelial_tumor\", fil_col = fil_c, wd = .4,\n                       axistheme = axistheme2, ylim = 0.7, label_y = c(0.5,0.55,0.6), compare = my_comparisons_tp)\np2 <- boxplot_clinical(df = tp_df, sel_group = \"stype2\", celltype = \"mCAF\", fil_col = fil_c, wd = .4,\n                       axistheme = axistheme2, ylim = 0.8, label_y = c(0.6,0.65,0.7), compare = my_comparisons_tp)\np3 <- boxplot_clinical(df = tp_df, sel_group = \"stype2\", celltype = \"CAF_col1p\", fil_col = fil_c, wd = .4,\n                       axistheme = axistheme2, ylim = 0.3, label_y = c(0.2,0.23,0.26), compare = my_comparisons_tp)\np4 <- boxplot_clinical(df = tp_df, sel_group = \"stype2\", celltype = \"Macrophage_HLADRn_CD163n\", fil_col = fil_c, wd = .4,\n                       axistheme = axistheme2, ylim = 0.4, label_y = c(0.3,0.33,0.36), compare = my_comparisons_tp)\np5 <- boxplot_clinical(df = tp_df, sel_group = \"stype2\", celltype = \"MMT_HLADRn_CD163n\", fil_col = fil_c, wd = .4,\n                       axistheme = axistheme2, ylim = 0.2, label_y = c(0.1,0.13,0.16), compare = my_comparisons_tp)\np6 <- boxplot_clinical(df = tp_df, sel_group = \"stype2\", celltype = \"CD8T\", fil_col = fil_c, wd = .4,\n                       axistheme = axistheme2, ylim = 0.1, label_y = c(0.05,0.07,0.09), compare = my_comparisons_tp)\np7 <- boxplot_clinical(df = tp_df, sel_group = \"stype2\", celltype = \"CD4T\", fil_col = fil_c, wd = .4,\n                       axistheme = axistheme2, ylim = 0.005, label_y = c(0.0005,0.0006,0.0007), compare = my_comparisons_tp)\np8 <- boxplot_clinical(df = tp_df, sel_group = \"stype2\", celltype = \"Monocyte\", fil_col = fil_c, wd = .4,\n                       axistheme = axistheme2, ylim = 0.03, label_y = c(0.02,0.023,0.026), compare = my_comparisons_tp)\np9 <- boxplot_clinical(df = tp_df, sel_group = \"stype2\", celltype = \"immunecells\", fil_col = fil_c, wd = .4,\n                       axistheme = axistheme2, ylim = 1, label_y = c(0.8,0.85,0.9), compare = my_comparisons_tp)\n\np <- (p1|p2|p3|p9|plot_spacer())/(p4|p5|p6|p7|p8)\nggsave(glue::glue(\"{res_dir}/figure1sup5a_cellprop_tumor_para.pdf\"), p, width = 6, height = 4)\np\n```\n\n::: {.cell-output-display}\n![](figure1_files/figure-html/figure1sup5a-1.png){width=672}\n:::\n:::\n\n\n\n\n\n## figure1sup5b\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# stages_tme\nstages_tme <- metadata[[\"stages_tme\"]] %>% dplyr::select(patient_id, stage) %>%\n  mutate(patient_id = glue::glue(\"{patient_id}_pdac\")) \nst_df <- metadata[[\"cell_ratio\"]] %>% inner_join(stages_tme, by = c(\"sample_id\" = \"patient_id\"))\n\nmy_comparisons_st <- list(c(\"RPC\", \"BRPC_LAPC\"), c(\"RPC\", \"MPC\"), c(\"BRPC_LAPC\", \"MPC\"))\nst_df$stage <- factor(st_df$stage, levels = c(\"MPC\", \"BRPC_LAPC\", \"RPC\") %>% rev())\nfil_c <- c(\"MPC\" = \"#BC3C29FF\", \"BRPC_LAPC\" = \"#0072B5FF\", \"RPC\" = \"#E18727FF\")\n\np1 <- boxplot_clinical(df = st_df, sel_group = \"stage\", celltype = \"Macrophage_HLADRn_CD163n\", fil_col = fil_c, wd = .4,\n                        axistheme = axistheme2, ylim = 0.5, label_y = c(0.35,0.4,0.45), compare = my_comparisons_st)\np2 <- boxplot_clinical(df = st_df, sel_group = \"stage\", celltype = \"mCAF\", fil_col = fil_c, wd = .4,\n                       axistheme = axistheme2, ylim = 1.0, label_y = c(0.7,0.8,0.9), compare = my_comparisons_st)\n\np <- p1|p2\nggsave(glue::glue(\"{res_dir}/figure1sup5b_cellprop_stages_tme.pdf\"), p, width = 6, height = 4)\np\n```\n\n::: {.cell-output-display}\n![](figure1_files/figure-html/figure1sup5b-1.png){width=576}\n:::\n:::\n\n\n\n\n\n\n\n## figure1sup5c\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# mpc_primary_metastasis\nsampleinfo <- sinfo %>% dplyr::select(sample_id, stype2) %>% distinct() %>% \n  dplyr::filter(stype2 %in% c(\"puncture_pdac\", \"puncture_liver\"))\nmpm_df <- metadata[[\"cell_ratio\"]] %>% inner_join(sampleinfo, by = \"sample_id\") %>%\n  dplyr::mutate(stype2 = case_when(stype2 == \"puncture_pdac\" ~ \"Biopsy pancreas\",\n                                   stype2 == \"puncture_liver\" ~ \"Biopsy liver\"))\nmy_comparisons_mpm <- list(c(\"Biopsy pancreas\", \"Biopsy liver\"))\nmpm_df$stype2<- factor(mpm_df$stype2, levels = c(\"Biopsy pancreas\", \"Biopsy liver\") %>% rev())\nfil_c <- c(\"Biopsy pancreas\" = \"#BC3C29FF\", \"Biopsy liver\" = \"#0072B5FF\")\n\np1 <- boxplot_clinical(df = mpm_df, sel_group = \"stype2\", celltype = \"CD8T\", fil_col = fil_c,\n                       axistheme = axistheme2, ylim = 0.025, label_y = 0.015, compare = my_comparisons_mpm)\np2 <- boxplot_clinical(df = mpm_df, sel_group = \"stype2\", celltype = \"Macrophage_HLADRn_CD163n\", fil_col = fil_c,\n                       axistheme = axistheme2, ylim = 0.6, label_y = 0.5, compare = my_comparisons_mpm)\np3 <- boxplot_clinical(df = mpm_df, sel_group = \"stype2\", celltype = \"mCAF\", fil_col = fil_c,\n                       axistheme = axistheme2, ylim = 0.8, label_y = 0.7, compare = my_comparisons_mpm)\n\np <- p1|p2|p3\nggsave(glue::glue(\"{res_dir}/figure1sup5c_cellprop_metastasis.pdf\"), p, width = 3.6, height = 4)\np\n```\n\n::: {.cell-output-display}\n![](figure1_files/figure-html/figure1sup5c-1.png){width=345.6}\n:::\n:::\n\n\n\n\n\n\n## figure1sup5d\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nneoadj_vs_direct_surgery1 <- metadata[[\"neoadj_vs_direct_surgery\"]] %>% dplyr::select(patient_id, treatment_type) %>%\n  mutate(patient_id = glue::glue(\"{patient_id}_pdac\"))\nneoadj_vs_direct_surgery2 <- metadata[[\"neoadj_vs_direct_surgery\"]] %>% dplyr::select(patient_id, treatment_type) %>%\n  mutate(patient_id = glue::glue(\"{patient_id}_ca\"))\nneoadj_vs_direct_surgery <- rbind(neoadj_vs_direct_surgery1, neoadj_vs_direct_surgery2) %>%\n  dplyr::mutate(treatment_type = case_when(treatment_type == \"surgery_after_chemo\" ~ \"Surgery after chemo\",\n                                           treatment_type == \"direct_surgery\" ~ \"Upfront surgery\"))\nnds_df <- metadata[[\"cell_ratio\"]] %>% inner_join(neoadj_vs_direct_surgery, by = c(\"sample_id\" = \"patient_id\"))\n\nmy_comparisons_nds <- list(c(\"Upfront surgery\", \"Surgery after chemo\"))\nnds_df$treatment_group<- factor(nds_df$treatment_type, levels = c(\"Upfront surgery\", \"Surgery after chemo\")%>% rev())\nfil_c <- c(\"Upfront surgery\" = \"#BC3C29FF\", \"Surgery after chemo\" = \"#0072B5FF\")\n\np1 <- boxplot_clinical(df = nds_df, sel_group = \"treatment_group\", celltype = \"Epithelial_tumor\", fil_col = fil_c,\n                       axistheme = axistheme2, ylim = 0.7, label_y = 0.6, compare = my_comparisons_nds)\np2 <- boxplot_clinical(df = nds_df, sel_group = \"treatment_group\", celltype = \"CAF_col1p\", fil_col = fil_c,\n                       axistheme = axistheme2, ylim = 0.5, label_y = 0.4, compare = my_comparisons_nds)\np3 <- boxplot_clinical(df = nds_df, sel_group = \"treatment_group\", celltype = \"MMT_HLADRp\", fil_col = fil_c,\n                       axistheme = axistheme2, ylim = 0.4, label_y = 0.3, compare = my_comparisons_nds)\np4 <- boxplot_clinical(df = nds_df, sel_group = \"treatment_group\", celltype = \"CD4T\", fil_col = fil_c,\n                       axistheme = axistheme2, ylim = 0.03, label_y = 0.02, compare = my_comparisons_nds)\np5 <- boxplot_clinical(df = nds_df, sel_group = \"treatment_group\", celltype = \"Macrophage_HLADRn_CD163n\", fil_col = fil_c,\n                       axistheme = axistheme2, ylim = 0.4, label_y = 0.3, compare = my_comparisons_nds)\n\np <- p1|p2|p3|p4|p5\nggsave(glue::glue(\"{res_dir}/figure1sup5d_cellprop_chemo.pdf\"), p, width = 6, height = 4)\np\n```\n\n::: {.cell-output-display}\n![](figure1_files/figure-html/figure1sup5d-1.png){width=576}\n:::\n:::\n",
    "supporting": [
      "figure1_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}