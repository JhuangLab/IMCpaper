{
  "hash": "1d7b0c23783ee7dd017defb2f861d604",
  "result": {
    "engine": "knitr",
    "markdown": "# sup_figure8\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\npkgs <- c(\"fs\", \"futile.logger\", \"configr\", \"stringr\", \"ggpubr\", \"ggthemes\", \n          \"SingleCellExperiment\", \"BiocNeighbors\", \"vroom\", \"jhtools\", \"glue\", \n          \"openxlsx\", \"ggsci\", \"patchwork\", \"cowplot\", \"tidyverse\", \"dplyr\", \n          \"survminer\", \"survival\")\nfor (pkg in pkgs){\n  suppressPackageStartupMessages(library(pkg, character.only = T))\n}\nres_dir <- \"./results/sup_figure8\" %>% checkdir\ndat_dir <- \"./data\" %>% checkdir\nconfig_dir <- \"./config\" %>% checkdir\n\n#colors config\nconfig_fn <- glue::glue(\"{config_dir}/configs.yaml\")\nstype3_cols <- jhtools::show_me_the_colors(config_fn, \"stype3\")\nctype10_cols <- jhtools::show_me_the_colors(config_fn, \"cell_type_new\")\nmeta_cols <- jhtools::show_me_the_colors(config_fn, \"meta_color\")\n\n#read in coldata\ncoldat <- readr::read_csv(glue::glue(\"{dat_dir}/sce_coldata.csv\"))\nsinfo <- readr::read_csv(glue::glue(\"{dat_dir}/metadata_sinfo.csv\"))\nsample_chemo_type_list <- readr::read_rds(glue::glue(\"{dat_dir}/sample_chemo_type_list.rds\"))\nmetadata <- readr::read_rds(glue::glue(\"{dat_dir}/metadata.rds\"))\nmeta_clu <- readxl::read_excel(glue::glue(\"{dat_dir}/meta_clu.xlsx\")) %>% dplyr::select(-9)\n\ngrid.draw.ggsurvplot <- function(x){\n  survminer:::print.ggsurvplot(x, newpage = FALSE)\n}\n```\n:::\n\n\n\n\n\n## sup_figure8ab\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nsample_to_tiff <- distinct(coldat[, c(\"stype2\", \"patient_id\", \"sample_id\", \"sample_tiff_id\")])\nmeta_os <- as.data.frame(metadata[[\"os_analysis\"]])\nmeta_pfs <- as.data.frame(metadata[[\"pfs_analysis\"]])\n\n# community interaction weight\ndf_inter_weighted <- metadata[[\"community_interaction_weighted\"]] \n\n# allsurgery samples\ndf_inter_weighted_new_allsurgery <- left_join(df_inter_weighted, sample_to_tiff, by = \"sample_tiff_id\") %>%\n  dplyr::filter(sample_id %in% c(sample_chemo_type_list[[\"chemo\"]], sample_chemo_type_list[[\"no_chemo_no_punc\"]]))\n\ndf_inter_weighted_new_allsurgery <- df_inter_weighted_new_allsurgery %>%\n  dplyr::mutate(interact_meta_bi = case_when(from_meta > to_meta ~ str_c(from_meta, \"_\", to_meta),\n                                             TRUE ~ str_c(to_meta, \"_\", from_meta)))\n\nmeta_nochemo_df <- df_inter_weighted_new_allsurgery %>%\n  group_by(interact_meta_bi, sample_id, patient_id) %>%\n  dplyr::summarise(mean_weight = mean(weight)) %>% ungroup()\n\nmetas <- names(table((meta_nochemo_df$interact_meta_bi)))[table((meta_nochemo_df$interact_meta_bi)) > 1]\n\nmeta_nochemo_col <- meta_nochemo_df %>% \n  dplyr::filter(interact_meta_bi %in% metas) %>%\n  pivot_wider(id_cols = c(\"sample_id\", \"patient_id\"),\n              names_from = interact_meta_bi,\n              values_from = mean_weight, values_fill = 1)\n\n# MC-tumor-frontline_MC-stroma-macro_vs_MC-tumor-frontline_MC-immune-enriched\n os_df <- meta_nochemo_col %>% dplyr::select(sample_id, patient_id, \n                                              `MC-tumor-frontline_MC-stroma-macro`,\n                                              `MC-tumor-frontline_MC-immune-enriched`) %>%\n      dplyr::mutate(weight_ratio = `MC-tumor-frontline_MC-stroma-macro`/`MC-tumor-frontline_MC-immune-enriched`) %>%\n      left_join(sinfo, by = c(\"sample_id\", \"patient_id\")) %>%\n      dplyr::mutate(group_median = case_when(weight_ratio >= median(weight_ratio) ~ \"high\", \n                                             weight_ratio < median(weight_ratio) ~ \"low\"))\n \nos_tmp <- os_df %>% dplyr::select(all_of(c(\"sample_id\", \"os_state\", \"os_month\", \"group_median\"))) %>% drop_na(os_month)\n#os\npsurv1 <- ggsurvplot(surv_fit(Surv(os_month, os_state) ~ group_median, data = os_tmp),\n                           palette = c(\"high\"=\"#BC3C29FF\", \"low\"=\"#0072B5FF\"),\n                           legend.labs = levels(droplevels(as.factor(unlist(os_tmp[, \"group_median\"])))),\n                           pval=T, risk.table = T)#, xlim = c(0,75))\nggsave(glue::glue(\"{res_dir}/sup_figure8a_os.pdf\"),\n             plot = psurv1, width = 5, height = 5)\n      \n\npfs_tmp <- os_df %>% dplyr::select(all_of(c(\"sample_id\", \"pfs_state\", \"pfs_month\", \"group_median\"))) %>% drop_na(pfs_month)\n#pfs\npsurv2 <- ggsurvplot(surv_fit(Surv(pfs_month, pfs_state) ~ group_median, data = pfs_tmp),\n                           palette = c(\"high\"=\"#BC3C29FF\", \"low\"=\"#0072B5FF\"),\n                           legend.labs = levels(droplevels(as.factor(unlist(pfs_tmp[, \"group_median\"])))),\n                           pval=T, risk.table = T)#, xlim = c(0,75))\nggsave(glue::glue(\"{res_dir}/sup_figure8a_pfs.pdf\"),\n             plot = psurv2, width = 5, height = 5)\n\n\n# MC-tumor-frontline_MC-stroma-mCAF_vs_MC-tumor-frontline_MC-immune-enriched\n os_df <- meta_nochemo_col %>% dplyr::select(sample_id, patient_id, \n                                              `MC-tumor-frontline_MC-stroma-mCAF`,\n                                              `MC-tumor-frontline_MC-immune-enriched`) %>%\n      dplyr::mutate(weight_ratio = `MC-tumor-frontline_MC-stroma-mCAF`/`MC-tumor-frontline_MC-immune-enriched`) %>%\n      left_join(sinfo, by = c(\"sample_id\", \"patient_id\")) %>%\n      dplyr::mutate(group_median = case_when(weight_ratio >= median(weight_ratio) ~ \"high\", \n                                             weight_ratio < median(weight_ratio) ~ \"low\"))\n \nos_tmp <- os_df %>% dplyr::select(all_of(c(\"sample_id\", \"os_state\", \"os_month\", \"group_median\"))) %>% drop_na(os_month)\n#os\npsurv3 <- ggsurvplot(surv_fit(Surv(os_month, os_state) ~ group_median, data = os_tmp),\n                           palette = c(\"high\"=\"#BC3C29FF\", \"low\"=\"#0072B5FF\"),\n                           legend.labs = levels(droplevels(as.factor(unlist(os_tmp[, \"group_median\"])))),\n                           pval=T, risk.table = T)#, xlim = c(0,75))\nggsave(glue::glue(\"{res_dir}/sup_figure8b_os.pdf\"),\n             plot = psurv3, width = 5, height = 5)\n      \n\npfs_tmp <- os_df %>% dplyr::select(all_of(c(\"sample_id\", \"pfs_state\", \"pfs_month\", \"group_median\"))) %>% drop_na(pfs_month)\n#pfs\npsurv4 <- ggsurvplot(surv_fit(Surv(pfs_month, pfs_state) ~ group_median, data = pfs_tmp),\n                           palette = c(\"high\"=\"#BC3C29FF\", \"low\"=\"#0072B5FF\"),\n                           legend.labs = levels(droplevels(as.factor(unlist(pfs_tmp[, \"group_median\"])))),\n                           pval=T, risk.table = T)#, xlim = c(0,75))\nggsave(glue::glue(\"{res_dir}/sup_figure8b_pfs.pdf\"),\n             plot = psurv4, width = 5, height = 5)\n\n\n(psurv2$plot | psurv1$plot) / (psurv4$plot | psurv3$plot)\n```\n\n::: {.cell-output-display}\n![](sup_figure8_files/figure-html/sup_figure8ab-1.png){width=960}\n:::\n:::\n\n\n\n\n\n\n## sup_figure8cd\n\n\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# no_chemo_no_punc\ndf_inter_weighted_new_nochemo <- left_join(df_inter_weighted, sample_to_tiff, by = \"sample_tiff_id\") %>%\n  dplyr::filter(sample_id %in% sample_chemo_type_list[[\"no_chemo_no_punc\"]])\n\ndf_inter_weighted_new_nochemo <- df_inter_weighted_new_nochemo %>%\n  dplyr::mutate(interact_meta_bi = case_when(from_meta > to_meta ~ str_c(from_meta, \"_\", to_meta),\n                                             TRUE ~ str_c(to_meta, \"_\", from_meta)))\n\nmeta_nochemo_df <- df_inter_weighted_new_nochemo %>%\n  group_by(interact_meta_bi, sample_id, patient_id) %>%\n  dplyr::summarise(mean_weight = mean(weight)) %>% ungroup()\n\nmetas <- names(table((meta_nochemo_df$interact_meta_bi)))[table((meta_nochemo_df$interact_meta_bi)) > 1]\n\nmeta_nochemo_col <- meta_nochemo_df %>% \n  dplyr::filter(interact_meta_bi %in% metas) %>%\n  pivot_wider(id_cols = c(\"sample_id\", \"patient_id\"),\n              names_from = interact_meta_bi,\n              values_from = mean_weight, values_fill = 1)\n\n# MC-tumor-frontline_MC-stroma-macro_vs_MC-tumor-frontline_MC-immune-enriched\n os_df <- meta_nochemo_col %>% dplyr::select(sample_id, patient_id, \n                                              `MC-tumor-frontline_MC-stroma-macro`,\n                                              `MC-tumor-frontline_MC-immune-enriched`) %>%\n      dplyr::mutate(weight_ratio = `MC-tumor-frontline_MC-stroma-macro`/`MC-tumor-frontline_MC-immune-enriched`) %>%\n      left_join(sinfo, by = c(\"sample_id\", \"patient_id\")) %>%\n      dplyr::mutate(group_median = case_when(weight_ratio >= median(weight_ratio) ~ \"high\", \n                                             weight_ratio < median(weight_ratio) ~ \"low\"))\n \nos_tmp <- os_df %>% dplyr::select(all_of(c(\"sample_id\", \"os_state\", \"os_month\", \"group_median\"))) %>% drop_na(os_month)\n#os\npsurv1 <- ggsurvplot(surv_fit(Surv(os_month, os_state) ~ group_median, data = os_tmp),\n                           palette = c(\"high\"=\"#BC3C29FF\", \"low\"=\"#0072B5FF\"),\n                           legend.labs = levels(droplevels(as.factor(unlist(os_tmp[, \"group_median\"])))),\n                           pval=T, risk.table = T)#, xlim = c(0,75))\nggsave(glue::glue(\"{res_dir}/sup_figure8c_os.pdf\"),\n             plot = psurv1, width = 5, height = 5)\n      \n\npfs_tmp <- os_df %>% dplyr::select(all_of(c(\"sample_id\", \"pfs_state\", \"pfs_month\", \"group_median\"))) %>% drop_na(pfs_month)\n#pfs\npsurv2 <- ggsurvplot(surv_fit(Surv(pfs_month, pfs_state) ~ group_median, data = pfs_tmp),\n                           palette = c(\"high\"=\"#BC3C29FF\", \"low\"=\"#0072B5FF\"),\n                           legend.labs = levels(droplevels(as.factor(unlist(pfs_tmp[, \"group_median\"])))),\n                           pval=T, risk.table = T)#, xlim = c(0,75))\nggsave(glue::glue(\"{res_dir}/sup_figure8c_pfs.pdf\"),\n             plot = psurv2, width = 5, height = 5)\n\n\n# MC-tumor-frontline_MC-stroma-mCAF_vs_MC-tumor-frontline_MC-immune-enriched\n os_df <- meta_nochemo_col %>% dplyr::select(sample_id, patient_id, \n                                              `MC-tumor-frontline_MC-stroma-mCAF`,\n                                              `MC-tumor-frontline_MC-immune-enriched`) %>%\n      dplyr::mutate(weight_ratio = `MC-tumor-frontline_MC-stroma-mCAF`/`MC-tumor-frontline_MC-immune-enriched`) %>%\n      left_join(sinfo, by = c(\"sample_id\", \"patient_id\")) %>%\n      dplyr::mutate(group_median = case_when(weight_ratio >= median(weight_ratio) ~ \"high\", \n                                             weight_ratio < median(weight_ratio) ~ \"low\"))\n \nos_tmp <- os_df %>% dplyr::select(all_of(c(\"sample_id\", \"os_state\", \"os_month\", \"group_median\"))) %>% drop_na(os_month)\n#os\npsurv3 <- ggsurvplot(surv_fit(Surv(os_month, os_state) ~ group_median, data = os_tmp),\n                           palette = c(\"high\"=\"#BC3C29FF\", \"low\"=\"#0072B5FF\"),\n                           legend.labs = levels(droplevels(as.factor(unlist(os_tmp[, \"group_median\"])))),\n                           pval=T, risk.table = T)#, xlim = c(0,75))\nggsave(glue::glue(\"{res_dir}/sup_figure8d_os.pdf\"),\n             plot = psurv3, width = 5, height = 5)\n      \n\npfs_tmp <- os_df %>% dplyr::select(all_of(c(\"sample_id\", \"pfs_state\", \"pfs_month\", \"group_median\"))) %>% drop_na(pfs_month)\n#pfs\npsurv4 <- ggsurvplot(surv_fit(Surv(pfs_month, pfs_state) ~ group_median, data = pfs_tmp),\n                           palette = c(\"high\"=\"#BC3C29FF\", \"low\"=\"#0072B5FF\"),\n                           legend.labs = levels(droplevels(as.factor(unlist(pfs_tmp[, \"group_median\"])))),\n                           pval=T, risk.table = T)#, xlim = c(0,75))\nggsave(glue::glue(\"{res_dir}/sup_figure8d_pfs.pdf\"),\n             plot = psurv4, width = 5, height = 5)\n\n(psurv2$plot | psurv1$plot) / (psurv4$plot | psurv3$plot)\n```\n\n::: {.cell-output-display}\n![](sup_figure8_files/figure-html/sup_figure8cd-1.png){width=960}\n:::\n:::\n",
    "supporting": [
      "sup_figure8_files"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {},
    "preserve": {},
    "postProcess": true
  }
}